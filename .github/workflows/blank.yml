name: Update release notes

on:
  workflow_dispatch:

jobs:
  update-release-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # needed so we can push changes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install python dependencies
        run: pip install requests

      - name: Generate [tag].md files for all releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python << 'PY'
          import os, pathlib, requests, re
          from requests.adapters import HTTPAdapter
          from urllib3.util.retry import Retry
          from requests.exceptions import ChunkedEncodingError
          
          repo = os.environ["GITHUB_REPOSITORY"]  # e.g. data-others/brain
          token = os.environ.get("GITHUB_TOKEN", "")
          account, repo_name = repo.split("/")
          
          session = requests.Session()
          retries = Retry(
              total=5,
              backoff_factor=1,
              status_forcelist=[500, 502, 503, 504],
              raise_on_status=False,
          )
          session.mount("https://", HTTPAdapter(max_retries=retries))
          
          headers = {
              "Accept": "application/vnd.github+json",
              "Connection": "close",
          }
          if token:
              headers["Authorization"] = f"Bearer {token}"
          
          def safe_get(url):
              for attempt in range(5):
                  try:
                      resp = session.get(url, headers=headers, timeout=30)
                      resp.raise_for_status()
                      return resp
                  except ChunkedEncodingError as e:
                      if attempt == 4:
                          raise
                      print(f"ChunkedEncodingError, retry {attempt+1}/5: {e}")
          
          releases = []
          url = f"https://api.github.com/repos/{repo}/releases?per_page=100"
          while url:
              resp = safe_get(url)
              releases.extend(resp.json())
              url = resp.links.get("next", {}).get("url")
          
          for rel in releases:
              tag = rel.get("tag_name") or "untagged"
              title = rel.get("name") or tag
              body = rel.get("body") or ""
          
              # Normalize newlines
              body = body.replace('\r\n', '\n').strip()
          
              # --- Ensure first heading line ---
              lines = body.splitlines() if body else []
              if not lines:
                  lines = [f"# **{title}**"]
              else:
                  first = lines[0].strip()
                  # if not a heading, insert one
                  if not first.startswith("#"):
                      lines.insert(0, f"# **{title}**")
                  else:
                      # if first line starts with '## ' or '### ', promote to single '# '
                      lines[0] = re.sub(r"^(#{2,3})\s*", "# ", first)
          
              # --- Demote subsequent headings (# -> ##, but skip first line) ---
              new_lines = [lines[0]]
              for line in lines[1:]:
                  new_lines.append(re.sub(r"^(# )", "## ", line))
              body = "\n".join(new_lines)
          
              # --- Build release link section ---
              link = f"https://github.com/{account}/{repo_name}/releases/tag/{tag}"
              text = f"{body}\n\n## Release Link\n{link}\n"
          
              fn = pathlib.Path(f"{tag}.md")
              fn.write_text(text, encoding="utf-8")
          
          PY


      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add *.md || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update release notes from GitHub releases"
          git push
